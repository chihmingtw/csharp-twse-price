@{
    ViewBag.Title = "Home Page";
}

<main id="Page">
    <br />
    <div class="panel panel-default">
        <div class="panel-heading">範例1 即時股價</div>
        <div class="panel-body">
            <div class="form-group">
                <label class="control-label col-sm-2">股票:</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" v-model="form.Q_SYMBOL_1.value">
                </div>
            </div>
            <button type="button" class="btn btn-primary" v-on:click="GetRealtimePrice()">查詢</button>

        </div>
        <div class="panel-footer">
            <span v-html="realPrice"></span>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">範例2 每日收盤行情</div>
        <div class="panel-body">
            <div class="form-group">
                <label class="control-label col-sm-2">日期:</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" v-model="form.Q_DATE_2.value">
                </div>
            </div>
            <button type="button" class="btn btn-primary" v-on:click="GetDayPrice()">查詢</button>
        </div>
        <div class="panel-footer">
            <div class="table-responsive" style="overflow-y:auto;height:400px;">
                <table class="table">
                    <tr>
                        <th>代碼</th>
                        <th>名稱</th>
                        <th>開盤價</th>
                        <th>最高價</th>
                        <th>最低價</th>
                        <th>收盤價</th>
                        <th>成交量</th>
                    </tr>
                    <tr v-for="(item, index) in gridDay.datas">
                        <td>
                            {{item.symbolCode}}
                        </td>
                        <td>
                            {{item.symbolName}}
                        </td>
                        <td>
                            {{item.open}}
                        </td>
                        <td>{{item.high}}</td>
                        <td>{{item.low}}</td>
                        <td>{{item.close}}</td>
                        <td>{{item.volume}}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">範例3 當月各日成交資訊</div>
        <div class="panel-body">
            <div class="form-group">
                <label class="control-label col-sm-2">股票:</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" v-model="form.Q_SYMBOL_3.value">
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2">日期:</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" v-model="form.Q_MONTH_3.value">
                </div>
            </div>
            <button type="button" class="btn btn-primary" v-on:click="GetMonthPrice()">查詢</button>
        </div>
        <div class="panel-footer">
            <div class="table-responsive">
                <table class="table">
                    <tr>
                        <th>日期</th>
                        <th>開盤價</th>
                        <th>最高價</th>
                        <th>最低價</th>
                        <th>收盤價</th>
                        <th>成交量</th>
                    </tr>
                    <tr v-for="(item, index) in gridMonthPirce.datas">
                        <td>{{item.date}}</td>
                        <td>{{item.open}}</td>
                        <td>{{item.high}}</td>
                        <td>{{item.low}}</td>
                        <td>{{item.close}}</td>
                        <td>{{item.volume}}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</main>
<script>
    var Page = new Vue({
        el: '#Page'
        , data: function () {
            var data = {
                form: {}
                , ctrlName: '@Url.Content("~/Home/")'
            };
            data.gridDay = {
                datas: []
            };
            data.realPrice = '';
            data.gridMonthPirce = {
                datas: []
            };

            return data;
        }
        , created: function () {
            var self = this;
            var columnList = [
                'Q_SYMBOL_1','Q_DATE_2','Q_SYMBOL_3','Q_MONTH_3'
            ];
            self._CreateForm(self.form, columnList);
            self.form.Q_SYMBOL_1.value = "2330,0050";
            var Today = new Date();
            var year = "" + Today.getFullYear();
            var month = "" + (Today.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
            var day = "" + Today.getDate(); if (day.length == 1) { day = "0" + day; }
            self.form.Q_DATE_2.value = year + month + day;
            self.form.Q_SYMBOL_3.value = "2330";
            self.form.Q_MONTH_3.value = year + month + day;
        }
        , methods: {
            GetToken: function () {
                var token = '@Html.AntiForgeryToken()';
                token = $(token).val();
                return token;
            }
            // 即時股價
            , GetRealtimePrice: function () {
                var self = this;
                var postData = self._GetPostData(self.form, "Q_");
                $.blockUI({ message: '處理中...' });
                $.ajax({
                    url:'@Url.Content("~/Home/GetRealtimePrice")',
                    method:'POST',
                    dataType:'json',
                    data: { inModel: postData, __RequestVerificationToken: self.GetToken() },
                    success: function (datas) {
                        self.realPrice = datas.realPrice;
                        $.unblockUI();
                    },
                    error: function (err) {
                        alert(err.responseText);
                    },
                });
            }
            // 每日收盤行情
            , GetDayPrice: function () {
                var self = this;
                var postData = self._GetPostData(self.form, "Q_");
                $.blockUI({ message: '處理中...' });
                $.ajax({
                    url:'@Url.Content("~/Home/GetDayPrice")',
                    method:'POST',
                    dataType:'json',
                    data: { inModel: postData, __RequestVerificationToken: self.GetToken() },
                    success: function (datas) {
                        self.gridDay.datas = [];
                        self._RowDataBound(self.gridDay.datas, datas.gridList);
                        $.unblockUI();
                    },
                    error: function (err) {
                        alert(err.responseText);
                    },
                });
            }
            // 當月各日成交資訊
            , GetMonthPrice: function () {
                var self = this;
                var postData = self._GetPostData(self.form, "Q_");
                $.blockUI({ message: '處理中...' });
                $.ajax({
                    url:'@Url.Content("~/Home/GetMonthPrice")',
                    method:'POST',
                    dataType:'json',
                    data: { inModel: postData, __RequestVerificationToken: self.GetToken() },
                    success: function (datas) {
                        self.gridMonthPirce.datas = [];
                        self._RowDataBound(self.gridMonthPirce.datas, datas.gridList);
                        $.unblockUI();
                    },
                    error: function (err) {
                        alert(err.responseText);
                    },
                });
            }
            // 產生欄位控制項
            , _CreateForm: function (form, variable) {
                for (var key in variable) {
                    control = {
                        id: variable[key]
                        , value: ''
                    };
                    Vue.set(form, variable[key], control);
                }
            }
            // 產生送往後端的資料
            , _GetPostData: function (form, blockName) {
                var postData = {};
                for (var key in form) {
                    if (key.substring(0, 2) !== blockName)
                        continue;
                    postData[key] = form[key].value;
                }
                return postData;
            }
            // 產生列表欄位控制項
            , _RowDataBound: function (gridDatas, datas) {
                for (var i in datas) {
                    var gridData = {};
                    for (var key in datas[i]) {
                        gridData[key] = datas[i][key];
                    }
                    gridDatas.push(gridData);
                }
            }
        }
    })
</script>